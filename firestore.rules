rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Super admin email
    function isSuperAdmin() {
      return request.auth.token.email == 'guestmenu0@gmail.com';
    }
    
    // Users collection - profiles and settings
    match /users/{userId} {
      allow read: if request.auth.uid == userId || isSuperAdmin();
      allow write: if request.auth.uid == userId || isSuperAdmin();
      allow create: if request.auth.uid == userId || isSuperAdmin();
      
      match /profile/{document=**} {
        allow read: if true; // Public read for guest menu display
        allow write: if request.auth.uid == userId || isSuperAdmin();
        allow create: if request.auth.uid == userId || isSuperAdmin();
      }
      
      match /settings/{document=**} {
        allow read: if request.auth.uid == userId || isSuperAdmin();
        allow write: if request.auth.uid == userId || isSuperAdmin();
        allow create: if request.auth.uid == userId || isSuperAdmin();
      }
    }

    // Menus collection - accessible by owner, guests (public read), and super admin
    match /menus/{userId}/{document=**} {
      allow read: if true; // Public menu pages
      allow write: if request.auth.uid == userId || isSuperAdmin();
      allow create: if request.auth.uid == userId || isSuperAdmin();
    }

    // Submissions - accessible by owner, their guests, and super admin
    match /submissions/{userId}/{document=**} {
      allow read: if request.auth.uid == userId || isSuperAdmin() || request.auth.uid != null;
      allow write: if request.auth.uid == userId || isSuperAdmin();
      allow create: if true; // Guests can submit anonymously
    }

    // Public menu access - any authenticated user
    match /publicMenus/{subdomain}/{document=**} {
      allow read: if true;
      allow write: if isSuperAdmin();
      allow create: if isSuperAdmin();
    }

    // Subdomain registry
    match /subdomains/{subdomain} {
      allow read: if true;
      allow write: if isSuperAdmin() || (resource != null && request.auth.uid == resource.data.userId);
      allow create: if isSuperAdmin() || request.auth.uid != null;
    }
    
    // Super Admin collection - read-only for super admin
    match /superAdmin/{document=**} {
      allow read: if isSuperAdmin();
      allow write: if false; // Prevent accidental writes
    }
  }
}
